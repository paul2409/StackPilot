# Vagrant configuration (version 2)
Vagrant.configure("2") do |config|

  # Base OS image for all machines
  # Ubuntu 22.04 LTS â€“ stable and suitable for k3s later
  config.vm.box = "ubuntu/jammy64"

  # Sync project repo into /vagrant inside each VM
  # This allows provisioning scripts to be reused across nodes
  config.vm.synced_folder "C:/Projects/StackPilot", "/vagrant", type: "virtualbox"

  # Canonical definition of all nodes
  # Single source of truth for identity and resources
  nodes = [
    {
      name: "control",
      ip: "192.168.56.10",
      memory: 8000,
      cpus: 3
    },
    {
      name: "worker1",
      ip: "192.168.56.11",
      memory: 4100,
      cpus: 2
    },
    {
      name: "worker2",
      ip: "192.168.56.12",
      memory: 4100,
      cpus: 2
    }
  ]

  nodes.each do |node|
    config.vm.define node[:name] do |n|

      # Hostname must match logical node name
      n.vm.hostname = node[:name]

      # Private network with static IP
      n.vm.network "private_network", ip: node[:ip]

      # --- Provisioning ---
      # Baseline OS packages and tooling (idempotent)
      n.vm.provision "shell",
        path: "../scripts/provision.sh",
        privileged: true

      # Enforce deterministic hostname resolution
      # This manages only the StackPilot block in /etc/hosts
      n.vm.provision "shell",
        path: "../scripts/hosts.sh",
        privileged: true

      # --- Provider configuration ---
      n.vm.provider "virtualbox" do |vb|
        vb.name   = "stackpilot-#{node[:name]}"
        vb.memory = node[:memory]
        vb.cpus   = node[:cpus]
      end
    end
  end
end
